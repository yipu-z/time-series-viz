<!DOCTYPE html>
<html lang="en">

<head>
  <title>Gizmo Visualizer</title>
  <meta charset="utf-8">
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <style>
    .graph .axis {
      stroke-width: 1;
    }

    .graph .axis .tick line {
      stroke: black;
    }

    .graph .axis .tick text {
      fill: black;
      font-size: 0.7em;
    }

    .graph .axis .domain {
      fill: none;
      stroke: black;
    }

    .graph .group {
      fill: none;
      stroke: black;
      stroke-width: 1.5;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <h5 id="user"></h5>
        <div id="test" class="">

        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12">
        <h1>Gizmo Visualizer</h1>
        <div class="graph"></div>
      </div>
    </div>
     <div class="row">
      <div class="col-sm-12">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#subjectSelectionModal">
        Select Subject Data
      </button>
      </div>
    </div>
  </div>


  <!-- Modal -->
  <div class="modal fade" id="subjectSelectionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="subjectModalTitle">Select Subject</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        </div>
        <div class="modal-body">
          <select id="subjectSelect" name="subjectSelect">
            <option value="" default readonly>Select...</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" id="select" class="btn btn-primary">Select</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-auth.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyAsp1Xn7i2xwWIoyR8RjMHDez5q0_MDPtw",
      authDomain: "gizmo-database.firebaseapp.com",
      databaseURL: "https://gizmo-database.firebaseio.com",
      projectId: "gizmo-database",
      storageBucket: "gizmo-database.appspot.com",
      messagingSenderId: "1099422978824"
    };
    firebase.initializeApp(config);

    //LOGIN(gmail)
    function login() {
      function newLoginHappened(user) {
        if (user) {
          //User is signed in, show name
          displayName(user);
        } else {
          //Request credentials
          var provider = new firebase.auth.GoogleAuthProvider();
          firebase.auth().signInWithRedirect(provider);
        }
      }
      firebase.auth().onAuthStateChanged(newLoginHappened);
    }

    function displayName(user) {
      $('#user').html('Logged in as ' + user.displayName);
    }
    window.onload= login;

    //READ FROM DATABASE
    var firebaseSubjectRef = firebase.database().ref();
    firebaseSubjectRef.on('value', function(datasnapshot){
      for (var i = 0; i < Object.keys(datasnapshot.val()).length; i++) {
        //Add each entry to subject selection
        var subjectId = Object.keys(datasnapshot.val())[i];
        $('#subjectSelect').append('<option value="'+subjectId+'">'+subjectId+'</option>');
      }
    });
    //Initialize bootstrap modal
    $('#subjectModal').on('shown.bs.modal', function() {
      $('#myInput').trigger('focus');
    })
    //Upon selection, store the selected user data on a variable
    $('#select').click(function(event) {
      var selectedSubject = $('#subjectSelect').val();
      var selectedSubjectRef = firebase.database().ref().child(selectedSubject);
      selectedSubjectRef.on('value', function(datasnapshot){
        var selectedSubjectData = datasnapshot.val();

        //HERE IS WHERE WE MANIPULATE THE DATA!!!!
        console.log(selectedSubjectData);
      });
    });

    //D3 STUFFS TODO: show number every second in time line. Prevent values to go outside chart. Show y axis scale.

    var limit = 60 * 1,
           duration = 750,
           now = new Date(Date.now() - duration)
       var width = 500,
           height = 200
       var groups = {
           current: {
               value: 0,
               color: 'orange',
               data: d3.range(limit).map(function() {
                   return 0
               })
           }
       }
       var x = d3.time.scale()
           .domain([now - (limit - 2), now - duration])
           .range([0, width])
       var y = d3.scale.linear()
           .domain([0, 100])
           .range([height, 0])
       var line = d3.svg.line()
           .interpolate('basis')
           .x(function(d, i) {
               return x(now - (limit - 1 - i) * duration)
           })
           .y(function(d) {
               return y(d)
           })
       var svg = d3.select('.graph').append('svg')
           .attr('class', 'chart')
           .attr('width', width)
           .attr('height', height + 50)
       var axis = svg.append('g')
           .attr('class', 'x axis')
           .attr('transform', 'translate(0,' + height + ')')
           .call(x.axis = d3.svg.axis().scale(x).orient('bottom'))
       var paths = svg.append('g')
       for (var name in groups) {
           var group = groups[name]
           group.path = paths.append('path')
               .data([group.data])
               .attr('class', name + ' group')
               .style('stroke', group.color)
       }
       function tick() {
       now = new Date()
           // Add new values
           for (var name in groups) {
               var group = groups[name]
               //group.data.push(group.value) // Real values arrive at irregular intervals
               group.data.push(20 + Math.random() * 100)
               group.path.attr('d', line)
           }
           // Shift domain
           x.domain([now - (limit - 2) * duration, now - duration])
           // Slide x-axis left
           axis.transition()
               .duration(duration)
               .ease('linear')
               .call(x.axis)
           // Slide paths left
           paths.attr('transform', null)
               .transition()
               .duration(duration)
               .ease('linear')
               .attr('transform', 'translate(' + x(now - (limit - 1) * duration) + ')')
               .each('end', tick)
           // Remove oldest data point from each group
           for (var name in groups) {
               var group = groups[name]
               group.data.shift()
           }
       }
       tick()
  </script>
</body>

</html>
